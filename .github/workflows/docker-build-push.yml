name: Build and Push Docker Images

on:
  push:
    branches:
      - main
      - master
    tags:
      - "v*"
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  IMAGE_PREFIX: ${{ secrets.DOCKERHUB_USERNAME }}/smartbin

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.IMAGE_PREFIX }}-frontend:${{ github.sha }},${{ env.IMAGE_PREFIX }}-frontend:latest
          no-cache: true
          build-args: |
            NEXT_PUBLIC_AUTH_SERVICE_URL=http://localhost:8001
            NEXT_PUBLIC_BIN_SERVICE_URL=http://localhost:8002
            NEXT_PUBLIC_DETECTION_SERVICE_URL=http://localhost:8003
            NEXT_PUBLIC_RECLAMATION_SERVICE_URL=http://localhost:8004
            NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
            CLERK_SECRET_KEY=${{ secrets.CLERK_SECRET_KEY }}
            NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
            NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
            NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/dashboard
            NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/dashboard

      - name: Build and push Gateway
        uses: docker/build-push-action@v5
        with:
          context: ./gateway
          file: ./gateway/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.IMAGE_PREFIX }}-gateway:${{ github.sha }},${{ env.IMAGE_PREFIX }}-gateway:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Auth Service
        uses: docker/build-push-action@v5
        with:
          context: ./services/auth_service
          file: ./services/auth_service/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.IMAGE_PREFIX }}-auth-service:${{ github.sha }},${{ env.IMAGE_PREFIX }}-auth-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Bin Service
        uses: docker/build-push-action@v5
        with:
          context: ./services/bin_service
          file: ./services/bin_service/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.IMAGE_PREFIX }}-bin-service:${{ github.sha }},${{ env.IMAGE_PREFIX }}-bin-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Detection Service
        uses: docker/build-push-action@v5
        with:
          context: ./services/detection_service
          file: ./services/detection_service/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.IMAGE_PREFIX }}-detection-service:${{ github.sha }},${{ env.IMAGE_PREFIX }}-detection-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Reclamation Service
        uses: docker/build-push-action@v5
        with:
          context: ./services/reclamation_service
          file: ./services/reclamation_service/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.IMAGE_PREFIX }}-reclamation-service:${{ github.sha }},${{ env.IMAGE_PREFIX }}-reclamation-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Node-RED
        uses: docker/build-push-action@v5
        with:
          context: ./node-red
          file: ./node-red/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.IMAGE_PREFIX }}-node-red:${{ github.sha }},${{ env.IMAGE_PREFIX }}-node-red:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        if: github.event_name != 'pull_request'
        run: |
          echo "## Docker Images Built and Pushed ðŸ³" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All images have been pushed to Docker Hub:" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_PREFIX }}-frontend:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_PREFIX }}-gateway:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_PREFIX }}-auth-service:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_PREFIX }}-bin-service:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_PREFIX }}-detection-service:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_PREFIX }}-reclamation-service:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_PREFIX }}-node-red:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Use \`docker-compose -f docker-compose.prod.yml pull\` to pull all images." >> $GITHUB_STEP_SUMMARY
